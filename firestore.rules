/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control system.
 *
 * Key Security Decisions:
 * - Admin Role Restriction: Admins are implicitly limited to user management tasks through Firebase Authentication, not Firestore data access.
 * - Accountant Access: Accountants are granted access to company-related data based on companyId association.
 * - Owner-Only Access for User Data: User profiles are strictly controlled by the user's ID.
 * - Global Data: Collections like 'institutions', 'afp-entities', etc., are read-only for all authenticated users to ensure data integrity.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper functions to keep rules DRY.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAccountantForCompany(companyId) {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyIds.hasAny([companyId]);
    }

    function isCompanyOwner(companyId) {
      let company = get(/databases/$(database)/documents/companies/$(companyId));
      return isSignedIn() && company.data.ownerId == request.auth.uid;
    }

    /**
     * User profiles are private to their owners.
     */
    match /users/{userId} {
      allow read, delete, update: if isOwner(userId);
      allow create: if isSignedIn();
    }
    
    /**
     * Company data is accessible to the accountant who owns it.
     */
    match /companies/{companyId} {
      allow get: if isAccountantForCompany(companyId);
      allow list: if isSignedIn(); // Accountants can list companies to find theirs
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isCompanyOwner(companyId);
    }
    
    /**
     * Subcollections within a company follow the company's ownership rule.
     */
    match /companies/{companyId}/{document=**} {
      allow read, write: if isAccountantForCompany(companyId);
    }

    /**
     * Global, read-only collections for all authenticated users.
     * These collections contain system-wide data and are not meant to be modified by end-users.
     */
     
    match /economic-indicators/{indicatorId} {
        allow read: if isSignedIn();
        allow write: if false; // Managed by admin/system
    }
    match /health-entities/{entityId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }
    match /afp-entities/{entityId} {
      allow read: if isSignedIn();
      allow write: if false;
    }
     match /family-allowance-parameters/{paramId} {
      allow read: if isSignedIn();
      allow write: if false;
    }
     match /tax-parameters/{paramId} {
      allow read: if isSignedIn();
      allow write: if false;
    }
    match /institutions/{institutionId} {
      allow read: if isSignedIn();
      allow write: if false;
    }

    /**
     * User-specific subcollections for customizations.
     */
    match /users/{userId}/account-groups/{groupId} {
      allow read, write: if isOwner(userId);
    }
  }
}

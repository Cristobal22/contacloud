(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,15288,e=>{"use strict";var r=e.i(43476),a=e.i(71645),l=e.i(75157);let t=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("div",{ref:t,className:(0,l.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",e),...a}));t.displayName="Card";let i=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("div",{ref:t,className:(0,l.cn)("flex flex-col space-y-1.5 p-6",e),...a}));i.displayName="CardHeader";let d=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("div",{ref:t,className:(0,l.cn)("text-2xl font-semibold leading-none tracking-tight",e),...a}));d.displayName="CardTitle";let s=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("div",{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",e),...a}));s.displayName="CardDescription";let o=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("div",{ref:t,className:(0,l.cn)("p-6 pt-0",e),...a}));o.displayName="CardContent";let n=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("div",{ref:t,className:(0,l.cn)("flex items-center p-6 pt-0",e),...a}));n.displayName="CardFooter",e.s(["Card",()=>t,"CardContent",()=>o,"CardDescription",()=>s,"CardFooter",()=>n,"CardHeader",()=>i,"CardTitle",()=>d])},84774,e=>{"use strict";var r=e.i(43476),a=e.i(71645),l=e.i(75157);let t=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("div",{className:"relative w-full overflow-auto",children:(0,r.jsx)("table",{ref:t,className:(0,l.cn)("w-full caption-bottom text-sm",e),...a})}));t.displayName="Table";let i=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("thead",{ref:t,className:(0,l.cn)("[&_tr]:border-b",e),...a}));i.displayName="TableHeader";let d=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("tbody",{ref:t,className:(0,l.cn)("[&_tr:last-child]:border-0",e),...a}));d.displayName="TableBody";let s=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("tfoot",{ref:t,className:(0,l.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",e),...a}));s.displayName="TableFooter";let o=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("tr",{ref:t,className:(0,l.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",e),...a}));o.displayName="TableRow";let n=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("th",{ref:t,className:(0,l.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",e),...a}));n.displayName="TableHead";let c=a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("td",{ref:t,className:(0,l.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",e),...a}));c.displayName="TableCell",a.forwardRef(({className:e,...a},t)=>(0,r.jsx)("caption",{ref:t,className:(0,l.cn)("mt-4 text-sm text-muted-foreground",e),...a})).displayName="TableCaption",e.s(["Table",()=>t,"TableBody",()=>d,"TableCell",()=>c,"TableFooter",()=>s,"TableHead",()=>n,"TableHeader",()=>i,"TableRow",()=>o])},24391,e=>{"use strict";var r=e.i(43476),a=e.i(71645),l=e.i(15288),t=e.i(19455),i=e.i(67489),d=e.i(10204),s=e.i(39126);e.i(11981);var o=e.i(80428),n=e.i(8406),c=e.i(45919),f=e.i(43104),u=e.i(84774);function m(){let{selectedCompany:e}=a.default.useContext(s.SelectedCompanyContext)||{},m=e?.id,p=new Date().getFullYear(),h=new Date().getMonth()+1,{toast:x}=(0,n.useToast)(),[b,g]=a.default.useState(p.toString()),[j,v]=a.default.useState(h.toString()),[N,C]=a.default.useState(!1),[y,T]=a.default.useState([]),{data:w,loading:R}=(0,o.useCollection)({path:m?`companies/${m}/employees`:void 0,companyId:m}),{data:S,loading:A}=(0,o.useCollection)({path:m?`companies/${m}/payrolls`:void 0,companyId:m,queryConstraints:[["year","==",parseInt(b)],["month","==",parseInt(j)]]}),D=R||A,E=async()=>{if(C(!0),T([]),!e||!w||!S){x({variant:"destructive",title:"Error de Carga",description:"No se pudieron cargar los datos. Asegúrate de seleccionar una empresa y que existan liquidaciones para el período."}),C(!1);return}let{validRows:r,errors:a}=function(e,r,a){let l=[],t=[];if(0===a.length)return t.push({rut:"N/A",fieldNumber:0,fieldName:"Nómina",error:"No se encontraron liquidaciones para el período seleccionado."}),{validRows:l,errors:t};for(let e of a){let a=r.find(r=>r.id===e.employeeId);if(!a){t.push({rut:"N/A",fieldNumber:0,fieldName:"Empleado",error:`No se encontr\xf3 el empleado con ID ${e.employeeId} para la liquidaci\xf3n del per\xedodo ${e.period}.`});continue}let i=[],d=Array(105).fill("");if(a.rut&&function(e){if(!/^[0-9]+-[0-9kK]{1}$/.test(e))return!1;let[r,a]=e.split("-"),l=0,t=2;for(let e=r.length-1;e>=0;e--)l+=parseInt(r.charAt(e),10)*t,t<7?t++:t=2;let i=11-l%11;return(11===i?"0":10===i?"K":i.toString()).toUpperCase()===a.toUpperCase()}(a.rut)){let[e,r]=a.rut.split("-");d[0]=e.replace(/\./g,""),d[1]=r}else i.push({rut:a.rut||"Sin RUT",fieldNumber:1,fieldName:"RUT Trabajador",error:"RUT inválido o faltante."});let s=e.workedDays;void 0===s||s<0||s>30?i.push({rut:a.rut,fieldNumber:13,fieldName:"Días Trabajados",error:`Valor '${s}' no es v\xe1lido. Debe estar entre 0 y 30.`}):d[12]=s,d[13]="00",a.afpEntity?void 0===e.taxableEarnings||e.taxableEarnings<0?i.push({rut:a.rut,fieldNumber:27,fieldName:"Renta Imponible AFP",error:"Dato faltante o inválido."}):d[26]=e.taxableEarnings:d[26]=0,a.afpEntity?void 0===e.afpDiscount||e.afpDiscount<0?i.push({rut:a.rut,fieldNumber:28,fieldName:"Cotización Obligatoria AFP",error:"Cálculo de cotización AFP faltante o inválido."}):d[27]=e.afpDiscount:d[27]=0;for(let e=0;e<d.length;e++)[12,26,27].includes(e)&&""===d[e]&&(d[e]=0);i.length>0?t.push(...i):l.push(d)}return{validRows:l,errors:t}}(0,w,S);if(a.length>0){T(a),x({variant:"destructive",title:"Errores de Validación",description:"Se encontraron problemas con los datos. Por favor, revisa la tabla de errores y corrige la información en el sistema."}),C(!1);return}if(0===r.length){x({variant:"default",title:"No Hay Datos Válidos",description:"No se encontraron registros válidos para generar el archivo después de las validaciones."}),C(!1);return}try{let e=r.map(e=>e.join(";")).join("\r\n"),a=new Blob([e],{type:"text/plain;charset=utf-8"}),l=document.createElement("a"),t=URL.createObjectURL(a);l.setAttribute("href",t),l.setAttribute("download",`previred_${b}_${j}.txt`),document.body.appendChild(l),l.click(),document.body.removeChild(l),x({title:"Archivo Generado con Éxito",description:"El archivo de Previred ha sido descargado."})}catch(e){console.error("Error generating file:",e),x({variant:"destructive",title:"Error Inesperado",description:"Ocurrió un error al generar el archivo. Revisa la consola para más detalles."})}C(!1)};return(0,r.jsxs)("div",{className:"grid gap-6",children:[(0,r.jsxs)(l.Card,{children:[(0,r.jsxs)(l.CardHeader,{children:[(0,r.jsx)(l.CardTitle,{children:"Generar Archivo para Previred"}),(0,r.jsx)(l.CardDescription,{children:"Genera el archivo de nómina de trabajadores para importar en Previred según las especificaciones de la Dirección del Trabajo."})]}),(0,r.jsx)(l.CardContent,{className:"space-y-4",children:(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4 items-end max-w-lg",children:[(0,r.jsxs)("div",{className:"flex-1 grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(d.Label,{htmlFor:"month",children:"Mes"}),(0,r.jsxs)(i.Select,{value:j,onValueChange:v,disabled:!m||D||N,children:[(0,r.jsx)(i.SelectTrigger,{id:"month",children:(0,r.jsx)(i.SelectValue,{})}),(0,r.jsx)(i.SelectContent,{children:Array.from({length:12},(e,a)=>(0,r.jsx)(i.SelectItem,{value:(a+1).toString(),children:(0,c.format)(new Date(0,a),"MMMM",{locale:f.es})},a+1))})]})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(d.Label,{htmlFor:"year",children:"Año"}),(0,r.jsxs)(i.Select,{value:b,onValueChange:g,disabled:!m||D||N,children:[(0,r.jsx)(i.SelectTrigger,{id:"year",children:(0,r.jsx)(i.SelectValue,{})}),(0,r.jsx)(i.SelectContent,{children:Array.from({length:5},(e,a)=>(0,r.jsx)(i.SelectItem,{value:(p-a).toString(),children:p-a},p-a))})]})]})]}),(0,r.jsx)(t.Button,{disabled:!m||D||N,onClick:E,children:D?"Cargando...":N?"Generando...":"Generar Archivo"})]})})]}),y.length>0&&(0,r.jsxs)(l.Card,{children:[(0,r.jsxs)(l.CardHeader,{children:[(0,r.jsx)(l.CardTitle,{className:"text-destructive",children:"Reporte de Errores de Validación"}),(0,r.jsx)(l.CardDescription,{children:"Corrige estos datos en las fichas de los trabajadores o en las liquidaciones antes de volver a generar el archivo."})]}),(0,r.jsx)(l.CardContent,{children:(0,r.jsxs)(u.Table,{children:[(0,r.jsx)(u.TableHeader,{children:(0,r.jsxs)(u.TableRow,{children:[(0,r.jsx)(u.TableHead,{children:"Trabajador (RUT)"}),(0,r.jsx)(u.TableHead,{children:"Campo N°"}),(0,r.jsx)(u.TableHead,{children:"Nombre del Campo"}),(0,r.jsx)(u.TableHead,{children:"Descripción del Error"})]})}),(0,r.jsx)(u.TableBody,{children:y.map((e,a)=>(0,r.jsxs)(u.TableRow,{children:[(0,r.jsx)(u.TableCell,{children:e.rut}),(0,r.jsx)(u.TableCell,{children:e.fieldNumber}),(0,r.jsx)(u.TableCell,{children:e.fieldName}),(0,r.jsx)(u.TableCell,{children:e.error})]},a))})]})})]})]})}e.s(["default",()=>m],24391)}]);
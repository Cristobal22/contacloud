(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,15288,e=>{"use strict";var a=e.i(43476),t=e.i(71645),s=e.i(75157);let r=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,s.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",e),...t}));r.displayName="Card";let o=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",e),...t}));o.displayName="CardHeader";let l=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,s.cn)("text-2xl font-semibold leading-none tracking-tight",e),...t}));l.displayName="CardTitle";let n=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,s.cn)("text-sm text-muted-foreground",e),...t}));n.displayName="CardDescription";let i=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,s.cn)("p-6 pt-0",e),...t}));i.displayName="CardContent";let c=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex items-center p-6 pt-0",e),...t}));c.displayName="CardFooter",e.s(["Card",()=>r,"CardContent",()=>i,"CardDescription",()=>n,"CardFooter",()=>c,"CardHeader",()=>o,"CardTitle",()=>l])},84774,e=>{"use strict";var a=e.i(43476),t=e.i(71645),s=e.i(75157);let r=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{className:"relative w-full overflow-auto",children:(0,a.jsx)("table",{ref:r,className:(0,s.cn)("w-full caption-bottom text-sm",e),...t})}));r.displayName="Table";let o=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("thead",{ref:r,className:(0,s.cn)("[&_tr]:border-b",e),...t}));o.displayName="TableHeader";let l=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("tbody",{ref:r,className:(0,s.cn)("[&_tr:last-child]:border-0",e),...t}));l.displayName="TableBody";let n=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("tfoot",{ref:r,className:(0,s.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",e),...t}));n.displayName="TableFooter";let i=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("tr",{ref:r,className:(0,s.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",e),...t}));i.displayName="TableRow";let c=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("th",{ref:r,className:(0,s.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",e),...t}));c.displayName="TableHead";let d=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("td",{ref:r,className:(0,s.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",e),...t}));d.displayName="TableCell",t.forwardRef(({className:e,...t},r)=>(0,a.jsx)("caption",{ref:r,className:(0,s.cn)("mt-4 text-sm text-muted-foreground",e),...t})).displayName="TableCaption",e.s(["Table",()=>r,"TableBody",()=>l,"TableCell",()=>d,"TableFooter",()=>n,"TableHead",()=>c,"TableHeader",()=>o,"TableRow",()=>i])},10204,e=>{"use strict";var a=e.i(43476),t=e.i(71645),s=e.i(48425),r=t.forwardRef((e,t)=>(0,a.jsx)(s.Primitive.label,{...e,ref:t,onMouseDown:a=>{a.target.closest("button, input, select, textarea")||(e.onMouseDown?.(a),!a.defaultPrevented&&a.detail>1&&a.preventDefault())}}));r.displayName="Label";var o=e.i(25913),l=e.i(75157);let n=(0,o.cva)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),i=t.forwardRef(({className:e,...t},s)=>(0,a.jsx)(r,{ref:s,className:(0,l.cn)(n(),e),...t}));i.displayName=r.displayName,e.s(["Label",()=>i],10204)},88515,e=>{"use strict";var a=e.i(35684);function t(e){let t=(0,a.toDate)(e),s=t.getMonth();return t.setFullYear(t.getFullYear(),s+1,0),t.setHours(0,0,0,0),t}e.s(["lastDayOfMonth",()=>t])},38815,e=>{"use strict";var a=e.i(35684);function t(e,t){return+(0,a.toDate)(e)<+(0,a.toDate)(t)}e.s(["isBefore",()=>t])},29592,e=>{"use strict";var a=e.i(43476),t=e.i(71645),s=e.i(25913),r=e.i(75157);let o=(0,s.cva)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),l=t.forwardRef(({className:e,variant:t,...s},l)=>(0,a.jsx)("div",{ref:l,role:"alert",className:(0,r.cn)(o({variant:t}),e),...s}));l.displayName="Alert";let n=t.forwardRef(({className:e,...t},s)=>(0,a.jsx)("h5",{ref:s,className:(0,r.cn)("mb-1 font-medium leading-none tracking-tight",e),...t}));n.displayName="AlertTitle";let i=t.forwardRef(({className:e,...t},s)=>(0,a.jsx)("div",{ref:s,className:(0,r.cn)("text-sm [&_p]:leading-relaxed",e),...t}));i.displayName="AlertDescription",e.s(["Alert",()=>l,"AlertDescription",()=>i,"AlertTitle",()=>n])},63209,e=>{"use strict";let a=(0,e.i(75254).default)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);e.s(["AlertCircle",()=>a],63209)},37822,e=>{"use strict";var a=e.i(43476),t=e.i(71645),s=e.i(81140),r=e.i(20783),o=e.i(30030),l=e.i(26330),n=e.i(3536),i=e.i(65491),c=e.i(10772),d=e.i(53660),u=e.i(74606),p=e.i(96626),h=e.i(48425),m=e.i(91918),x=e.i(69340),f=e.i(86312),g=e.i(85369),b="Popover",[C,j]=(0,o.createContextScope)(b,[d.createPopperScope]),v=(0,d.createPopperScope)(),[N,y]=C(b),T=e=>{let{__scopePopover:s,children:r,open:o,defaultOpen:l,onOpenChange:n,modal:i=!1}=e,u=v(s),p=t.useRef(null),[h,m]=t.useState(!1),[f,g]=(0,x.useControllableState)({prop:o,defaultProp:l??!1,onChange:n,caller:b});return(0,a.jsx)(d.Root,{...u,children:(0,a.jsx)(N,{scope:s,contentId:(0,c.useId)(),triggerRef:p,open:f,onOpenChange:g,onOpenToggle:t.useCallback(()=>g(e=>!e),[g]),hasCustomAnchor:h,onCustomAnchorAdd:t.useCallback(()=>m(!0),[]),onCustomAnchorRemove:t.useCallback(()=>m(!1),[]),modal:i,children:r})})};T.displayName=b;var A="PopoverAnchor";t.forwardRef((e,s)=>{let{__scopePopover:r,...o}=e,l=y(A,r),n=v(r),{onCustomAnchorAdd:i,onCustomAnchorRemove:c}=l;return t.useEffect(()=>(i(),()=>c()),[i,c]),(0,a.jsx)(d.Anchor,{...n,...o,ref:s})}).displayName=A;var w="PopoverTrigger",R=t.forwardRef((e,t)=>{let{__scopePopover:o,...l}=e,n=y(w,o),i=v(o),c=(0,r.useComposedRefs)(t,n.triggerRef),u=(0,a.jsx)(h.Primitive.button,{type:"button","aria-haspopup":"dialog","aria-expanded":n.open,"aria-controls":n.contentId,"data-state":O(n.open),...l,ref:c,onClick:(0,s.composeEventHandlers)(e.onClick,n.onOpenToggle)});return n.hasCustomAnchor?u:(0,a.jsx)(d.Anchor,{asChild:!0,...i,children:u})});R.displayName=w;var P="PopoverPortal",[D,M]=C(P,{forceMount:void 0}),S=e=>{let{__scopePopover:t,forceMount:s,children:r,container:o}=e,l=y(P,t);return(0,a.jsx)(D,{scope:t,forceMount:s,children:(0,a.jsx)(p.Presence,{present:s||l.open,children:(0,a.jsx)(u.Portal,{asChild:!0,container:o,children:r})})})};S.displayName=P;var E="PopoverContent",F=t.forwardRef((e,t)=>{let s=M(E,e.__scopePopover),{forceMount:r=s.forceMount,...o}=e,l=y(E,e.__scopePopover);return(0,a.jsx)(p.Presence,{present:r||l.open,children:l.modal?(0,a.jsx)(I,{...o,ref:t}):(0,a.jsx)(L,{...o,ref:t})})});F.displayName=E;var $=(0,m.createSlot)("PopoverContent.RemoveScroll"),I=t.forwardRef((e,o)=>{let l=y(E,e.__scopePopover),n=t.useRef(null),i=(0,r.useComposedRefs)(o,n),c=t.useRef(!1);return t.useEffect(()=>{let e=n.current;if(e)return(0,f.hideOthers)(e)},[]),(0,a.jsx)(g.RemoveScroll,{as:$,allowPinchZoom:!0,children:(0,a.jsx)(H,{...e,ref:i,trapFocus:l.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:(0,s.composeEventHandlers)(e.onCloseAutoFocus,e=>{e.preventDefault(),c.current||l.triggerRef.current?.focus()}),onPointerDownOutside:(0,s.composeEventHandlers)(e.onPointerDownOutside,e=>{let a=e.detail.originalEvent,t=0===a.button&&!0===a.ctrlKey;c.current=2===a.button||t},{checkForDefaultPrevented:!1}),onFocusOutside:(0,s.composeEventHandlers)(e.onFocusOutside,e=>e.preventDefault(),{checkForDefaultPrevented:!1})})})}),L=t.forwardRef((e,s)=>{let r=y(E,e.__scopePopover),o=t.useRef(!1),l=t.useRef(!1);return(0,a.jsx)(H,{...e,ref:s,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:a=>{e.onCloseAutoFocus?.(a),a.defaultPrevented||(o.current||r.triggerRef.current?.focus(),a.preventDefault()),o.current=!1,l.current=!1},onInteractOutside:a=>{e.onInteractOutside?.(a),a.defaultPrevented||(o.current=!0,"pointerdown"===a.detail.originalEvent.type&&(l.current=!0));let t=a.target;r.triggerRef.current?.contains(t)&&a.preventDefault(),"focusin"===a.detail.originalEvent.type&&l.current&&a.preventDefault()}})}),H=t.forwardRef((e,t)=>{let{__scopePopover:s,trapFocus:r,onOpenAutoFocus:o,onCloseAutoFocus:c,disableOutsidePointerEvents:u,onEscapeKeyDown:p,onPointerDownOutside:h,onFocusOutside:m,onInteractOutside:x,...f}=e,g=y(E,s),b=v(s);return(0,n.useFocusGuards)(),(0,a.jsx)(i.FocusScope,{asChild:!0,loop:!0,trapped:r,onMountAutoFocus:o,onUnmountAutoFocus:c,children:(0,a.jsx)(l.DismissableLayer,{asChild:!0,disableOutsidePointerEvents:u,onInteractOutside:x,onEscapeKeyDown:p,onPointerDownOutside:h,onFocusOutside:m,onDismiss:()=>g.onOpenChange(!1),children:(0,a.jsx)(d.Content,{"data-state":O(g.open),role:"dialog",id:g.contentId,...b,...f,ref:t,style:{...f.style,"--radix-popover-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-popover-content-available-width":"var(--radix-popper-available-width)","--radix-popover-content-available-height":"var(--radix-popper-available-height)","--radix-popover-trigger-width":"var(--radix-popper-anchor-width)","--radix-popover-trigger-height":"var(--radix-popper-anchor-height)"}})})})}),k="PopoverClose";function O(e){return e?"open":"closed"}t.forwardRef((e,t)=>{let{__scopePopover:r,...o}=e,l=y(k,r);return(0,a.jsx)(h.Primitive.button,{type:"button",...o,ref:t,onClick:(0,s.composeEventHandlers)(e.onClick,()=>l.onOpenChange(!1))})}).displayName=k,t.forwardRef((e,t)=>{let{__scopePopover:s,...r}=e,o=v(s);return(0,a.jsx)(d.Arrow,{...o,...r,ref:t})}).displayName="PopoverArrow";var B=e.i(75157);let z=t.forwardRef(({className:e,align:t="center",sideOffset:s=4,...r},o)=>(0,a.jsx)(S,{children:(0,a.jsx)(F,{ref:o,align:t,sideOffset:s,className:(0,B.cn)("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...r})}));z.displayName=F.displayName,e.s(["Popover",()=>T,"PopoverContent",()=>z,"PopoverTrigger",()=>R],37822)},44523,e=>{"use strict";let a=(0,e.i(75254).default)("ChevronsUpDown",[["path",{d:"m7 15 5 5 5-5",key:"1hf1tw"}],["path",{d:"m7 9 5-5 5 5",key:"sgt6xg"}]]);e.s(["ChevronsUpDown",()=>a],44523)},888,e=>{"use strict";var a=e.i(43476),t=e.i(71645),s=e.i(43531),r=e.i(44523),o=e.i(75157),l=e.i(19455),n=e.i(17056),i=e.i(37822),c=e.i(10204);function d({label:e,value:d,onValueChange:u,accounts:p,loading:h}){let[m,x]=t.useState(!1),f=p.find(e=>e.code===d),g=(0,a.jsx)(i.PopoverContent,{className:"w-[--radix-popover-trigger-width] p-0",children:(0,a.jsxs)(n.Command,{children:[(0,a.jsx)(n.CommandInput,{placeholder:"Buscar por código o nombre..."}),(0,a.jsxs)(n.CommandList,{children:[(0,a.jsx)(n.CommandEmpty,{children:"No se encontró ninguna cuenta."}),(0,a.jsx)(n.CommandGroup,{children:p.filter(e=>1===e.code.length).map(e=>(0,a.jsxs)(t.Fragment,{children:[(0,a.jsx)("div",{className:"px-2 py-1.5 text-xs font-semibold text-muted-foreground",children:e.name}),p.filter(a=>a.code.startsWith(e.code)&&a.code!==e.code&&!(a.code.length<=5)).map(e=>(0,a.jsxs)(n.CommandItem,{value:`${e.code} ${e.name}`,onSelect:()=>{u(e.code),x(!1)},children:[(0,a.jsx)(s.Check,{className:(0,o.cn)("mr-2 h-4 w-4",d===e.code?"opacity-100":"opacity-0")}),e.code," - ",e.name]},e.id))]},e.code))})]})]})});return(0,a.jsxs)("div",{className:"space-y-2",children:[e&&(0,a.jsx)(c.Label,{children:e}),(0,a.jsxs)(i.Popover,{open:m,onOpenChange:x,children:[(0,a.jsx)(i.PopoverTrigger,{asChild:!0,children:(0,a.jsxs)(l.Button,{variant:"outline",role:"combobox","aria-expanded":m,className:"w-full justify-between font-normal",disabled:h,children:[h?"Cargando cuentas...":d?f?`${f.code} - ${f.name}`:d:"Seleccionar cuenta...",(0,a.jsx)(r.ChevronsUpDown,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),g]})]})}e.s(["AccountSearchInput",()=>d])},59500,e=>{"use strict";var a=e.i(35684);function t(e,t){return+(0,a.toDate)(e)==+(0,a.toDate)(t)}e.s(["isEqual",()=>t])},27784,e=>{"use strict";var a=e.i(43476),t=e.i(71645),s=e.i(15288),r=e.i(19455);e.i(11981);var o=e.i(80428),l=e.i(61480);e.i(36180);var n=e.i(17875),i=e.i(57094),c=e.i(50350),d=e.i(39126),u=e.i(8406),p=e.i(18566),h=e.i(84774),m=e.i(29592),x=e.i(63209),f=e.i(22016),g=e.i(45919),b=e.i(88515),C=e.i(86135),j=e.i(68264),v=e.i(59500),N=e.i(38815),y=e.i(43104),T=e.i(76639),A=e.i(888);function w(){let{selectedCompany:e}=t.default.useContext(d.SelectedCompanyContext)||{},w=e?.id,R=(0,l.useFirestore)(),{toast:P}=(0,u.useToast)(),D=(0,p.useRouter)(),M=t.default.useMemo(()=>R&&w?(0,n.query)((0,n.collection)(R,`companies/${w}/purchases`),(0,n.where)("status","==","Pendiente")):null,[R,w]),{data:S,loading:E}=(0,o.useCollection)({query:M}),{data:F,loading:$}=(0,o.useCollection)({path:w?`companies/${w}/accounts`:void 0}),{data:I,loading:L}=(0,o.useCollection)({path:w?`companies/${w}/subjects`:void 0}),[H,k]=t.default.useState([]),[O,B]=t.default.useState(!1),[z,V]=t.default.useState(null);t.default.useEffect(()=>{if(S&&I&&S.length>0){let e=new Map(I.map(e=>[e.rut,e.lastAssignedAccount])),a=0;k(S.map(t=>{if(!t.assignedAccount&&t.supplierRut){let s=e.get(t.supplierRut);if(s)return a++,{...t,id:t.id||(0,n.doc)((0,n.collection)(R,"purchases")).id,assignedAccount:s}}return{...t,id:t.id||(0,n.doc)((0,n.collection)(R,"purchases")).id}})),a>0&&P({title:"Asignación Automática",description:`Se asign\xf3 una cuenta a ${a} documento(s) basado en el historial del proveedor.`})}else S&&k(S.map(e=>({...e,id:e.id||(0,n.doc)((0,n.collection)(R,"purchases")).id})))},[S,I,R,P]);let[q,_]=t.default.useState(!1),G=E||$||L,{summary:U,totalDebit:K,totalCredit:Y,unassignedDocsCount:W,closedPeriodDocs:Z,purchasesToProcess:J,isValid:Q,isBalanced:X,totalIvaCredit:ee,otherTaxesSummary:ea,totalPayable:et,missingTaxAccounts:es}=t.default.useMemo(()=>{if(!H||!F||!e)return{summary:[],totalDebit:0,totalCredit:0,unassignedDocsCount:0,closedPeriodDocs:[],purchasesToProcess:[],isValid:!1,isBalanced:!1,totalIvaCredit:0,otherTaxesSummary:[],totalPayable:0,missingTaxAccounts:[]};let a=e.lastClosedDate?(0,C.parseISO)(e.lastClosedDate):null,t=H.filter(e=>{if(!a)return!0;try{let t=(0,C.parseISO)(e.date);return(0,j.isAfter)(t,a)}catch(e){return!0}}),s=H.filter(e=>{if(!a)return!1;try{let t=(0,C.parseISO)(e.date);return(0,N.isBefore)(t,a)||(0,v.isEqual)(t,a)}catch(e){return!1}}),r=t.filter(e=>!e.assignedAccount).length,o=new Map,l=new Map,n=0,i=0;t.forEach(e=>{let a=e.documentType.includes("61")?-1:1;if(i+=e.total*a,e.assignedAccount){let t=(e.netAmount+(e.exemptAmount||0))*a,s=o.get(e.assignedAccount)||{name:F.find(a=>a.code===e.assignedAccount)?.name||"N/A",total:0,count:0};s.total+=t,s.count++,o.set(e.assignedAccount,s)}n+=(e.taxAmount||0)*a,e.otherTaxes?.forEach(e=>{let t=(e.amount||0)*a,s=l.get(e.code)||{name:e.name,total:0};s.total+=t,l.set(e.code,s)})});let c=Array.from(o.entries()).map(([e,a])=>({accountCode:e,accountName:a.name,totalNet:a.total,docCount:a.count})),d=new Map(e.purchasesOtherTaxesAccounts?.map(e=>[e.taxCode,e.accountCode])),u=Array.from(l.entries()).map(([e,a])=>({code:e,name:a.name,total:a.total,accountCode:d.get(e)})),p=u.filter(e=>0!==e.total&&!e.accountCode),h=c.reduce((e,a)=>e+Math.max(0,a.totalNet),0)+Math.max(0,n)+u.reduce((e,a)=>e+Math.max(0,a.total),0)+Math.max(0,-i),m=c.reduce((e,a)=>e+Math.max(0,-a.totalNet),0)+Math.max(0,-n)+u.reduce((e,a)=>e+Math.max(0,-a.total),0)+Math.max(0,i),x=Math.round(h)===Math.round(m),f=0===r&&t.length>0&&x&&0===p.length;return{summary:c,totalIvaCredit:n,otherTaxesSummary:u,totalPayable:i,totalDebit:h,totalCredit:m,unassignedDocsCount:r,closedPeriodDocs:s,purchasesToProcess:t,isValid:f,isBalanced:x,missingTaxAccounts:p}},[H,F,e]),er=async()=>{if(!R||!w||!e||!J||!Q||!I)return void P({variant:"destructive",title:"Error de validación",description:"No se puede centralizar. Revisa que todo esté correcto y que todas las cuentas estén asignadas."});_(!0);let a=(0,n.writeBatch)(R),t=new Map(I.map(e=>[e.rut,e])),s=new Map,r=new Map;if(J.forEach(e=>{if(e.supplierRut&&(t.has(e.supplierRut)||s.has(e.supplierRut)||s.set(e.supplierRut,{rut:e.supplierRut,name:e.supplier}),e.assignedAccount)){let a=t.get(e.supplierRut);a&&a.id&&a.lastAssignedAccount!==e.assignedAccount&&r.set(e.supplierRut,{subjectId:a.id,account:e.assignedAccount})}}),s.size>0){let e=(0,n.collection)(R,`companies/${w}/subjects`);s.forEach(t=>{let s=(0,n.doc)(e);a.set(s,{name:t.name,rut:t.rut,type:"Proveedor",status:"Active",companyId:w})})}r.forEach(e=>{a.update((0,n.doc)(R,`companies/${w}/subjects`,e.subjectId),{lastAssignedAccount:e.account})});let o=e.periodStartDate?(0,C.parseISO)(e.periodStartDate):new Date,l=(0,b.lastDayOfMonth)(o),d=(0,g.format)(o,"MMMM",{locale:y.es}),u=[];U.forEach(e=>{u.push({account:e.accountCode,description:`Neto compras ${e.accountName}`,debit:e.totalNet>0?e.totalNet:0,credit:e.totalNet<0?-e.totalNet:0})}),0!==ee&&e.purchasesVatAccount&&u.push({account:e.purchasesVatAccount,description:"IVA Crédito Fiscal del período",debit:ee>0?ee:0,credit:ee<0?-ee:0}),ea.forEach(e=>{0!==e.total&&e.accountCode&&u.push({account:e.accountCode,description:e.name,debit:e.total>0?e.total:0,credit:e.total<0?-e.total:0})}),0!==et&&e.purchasesInvoicesPayableAccount&&u.push({account:e.purchasesInvoicesPayableAccount,description:"Cuentas por Pagar Proveedores",debit:et<0?-et:0,credit:et>0?et:0});let p=u.filter(e=>0!==e.debit||0!==e.credit),h=(0,n.doc)((0,n.collection)(R,`companies/${w}/vouchers`));a.set(h,{date:(0,g.format)(l,"yyyy-MM-dd"),type:"Traspaso",description:`Centralizaci\xf3n Compras ${d} ${o.getFullYear()}`,status:"Contabilizado",total:Math.abs(p.reduce((e,a)=>e+a.debit,0)),entries:p,companyId:w,createdAt:n.Timestamp.now()}),J.forEach(e=>{a.update((0,n.doc)(R,`companies/${w}/purchases`,e.id),{status:"Contabilizado",voucherId:h.id,assignedAccount:e.assignedAccount})});try{await a.commit(),P({title:"Centralización Exitosa",description:`El comprobante ha sido generado. ${r.size} preferencia(s) de proveedor guardada(s). ${s.size>0?`${s.size} nuevos proveedores creados.`:""}`}),D.push("/dashboard/vouchers")}catch(e){i.errorEmitter.emit("permission-error",new c.FirestorePermissionError({path:`companies/${w}`,operation:"update"})),_(!1)}};return G?(0,a.jsx)("p",{children:"Cargando y asignando cuentas..."}):S&&0!==S.length?(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)(s.Card,{children:[(0,a.jsxs)(s.CardHeader,{children:[(0,a.jsx)(s.CardTitle,{children:"1. Asignar Cuentas de Gasto"}),(0,a.jsx)(s.CardDescription,{children:"Revisa cada documento y asigna la cuenta contable de gasto o costo que corresponda. El sistema ha asignado cuentas automáticamente basado en centralizaciones anteriores."})]}),(0,a.jsx)(s.CardContent,{children:(0,a.jsxs)(h.Table,{children:[(0,a.jsx)(h.TableHeader,{children:(0,a.jsxs)(h.TableRow,{children:[(0,a.jsx)(h.TableHead,{className:"w-[120px]",children:"Fecha"}),(0,a.jsx)(h.TableHead,{children:"Proveedor"}),(0,a.jsx)(h.TableHead,{children:"Documento"}),(0,a.jsx)(h.TableHead,{className:"w-[350px]",children:"Cuenta de Gasto/Costo Asignada"}),(0,a.jsx)(h.TableHead,{className:"text-right",children:"Total"})]})}),(0,a.jsx)(h.TableBody,{children:H.map(e=>(0,a.jsxs)(h.TableRow,{className:e.assignedAccount?"":"bg-red-50/50",children:[(0,a.jsx)(h.TableCell,{children:e.date}),(0,a.jsx)(h.TableCell,{children:e.supplier}),(0,a.jsxs)(h.TableCell,{children:[e.documentType," ",e.documentNumber]}),(0,a.jsx)(h.TableCell,{children:(0,a.jsx)(A.AccountSearchInput,{label:"",value:e.assignedAccount||"",onValueChange:a=>{var t;return t=e.id,void k(e=>e.map(e=>e.id===t?{...e,assignedAccount:a}:e))},accounts:F||[],loading:$,placeholder:"Seleccionar cuenta..."})}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",e.total.toLocaleString("es-CL")]})]},e.id))})]})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold tracking-tight",children:"2. Vista Previa y Centralización"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"Verifica los totales y confirma la generación del asiento contable."})]}),(0,a.jsxs)(s.Card,{children:[(0,a.jsx)(s.CardHeader,{children:(0,a.jsx)(s.CardTitle,{children:"Resumen del Asiento a Generar"})}),(0,a.jsxs)(s.CardContent,{children:[es.length>0&&(0,a.jsxs)(m.Alert,{variant:"destructive",className:"mb-4",children:[(0,a.jsx)(x.AlertCircle,{className:"h-4 w-4"}),(0,a.jsx)(m.AlertTitle,{children:"Faltan Cuentas de Impuestos Adicionales"}),(0,a.jsxs)(m.AlertDescription,{children:[(0,a.jsxs)("p",{children:["Para poder centralizar, debes asignar una cuenta contable a los siguientes impuestos en la ",(0,a.jsx)(f.default,{href:"/dashboard/companies/settings",className:"font-bold underline",children:"configuración de la empresa"}),":"]}),(0,a.jsx)("ul",{className:"list-disc pl-5 mt-2 text-xs",children:es.map(e=>(0,a.jsxs)("li",{children:[e.name," (Código: ",e.code,")"]},e.code))})]})]}),W>0&&(0,a.jsxs)(m.Alert,{variant:"destructive",className:"mb-4",children:[(0,a.jsx)(x.AlertCircle,{className:"h-4 w-4"}),(0,a.jsxs)(m.AlertTitle,{children:["Atención Requerida: ",W," Documento(s) Sin Cuenta Asignada"]}),(0,a.jsxs)(m.AlertDescription,{className:"flex flex-col gap-2 mt-2",children:[(0,a.jsx)("p",{children:"Debes asignar una cuenta de gasto a todos los documentos en la tabla de arriba. Puedes hacerlo uno por uno o usar la opción de asignación masiva."}),(0,a.jsxs)(r.Button,{size:"sm",variant:"secondary",onClick:()=>B(!0),className:"mt-2",children:["Asignar Cuenta a ",W," Documentos"]})]})]}),Z.length>0&&(0,a.jsxs)(m.Alert,{variant:"destructive",className:"mb-4",children:[(0,a.jsx)(x.AlertCircle,{className:"h-4 w-4"}),(0,a.jsxs)(m.AlertTitle,{children:["Atención Requerida: ",Z.length," Documento(s) en Período Cerrado"]}),(0,a.jsxs)(m.AlertDescription,{children:[(0,a.jsx)("p",{children:"Estos documentos no serán incluidos en esta centralización:"}),(0,a.jsxs)("ul",{className:"list-disc pl-5 mt-2 text-xs",children:[Z.slice(0,5).map(e=>(0,a.jsxs)("li",{children:["Folio ",e.documentNumber," de ",e.supplier," (Fecha: ",new Date(e.date).toLocaleDateString("es-CL"),")"]},e.id)),Z.length>5&&(0,a.jsxs)("li",{children:["... y ",Z.length-5," más."]})]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"font-semibold text-lg",children:"DEBE (Cargos)"}),(0,a.jsxs)(h.Table,{children:[(0,a.jsx)(h.TableHeader,{children:(0,a.jsxs)(h.TableRow,{children:[(0,a.jsx)(h.TableHead,{children:"Cuenta Contable"}),(0,a.jsx)(h.TableHead,{className:"text-right",children:"Monto"})]})}),(0,a.jsxs)(h.TableBody,{children:[U.filter(e=>e.totalNet>0).map(e=>(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.accountCode," - ",e.accountName]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(e.totalNet).toLocaleString("es-CL")]})]},e.accountCode)),ee>0&&e?.purchasesVatAccount&&(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.purchasesVatAccount," - IVA Crédito Fiscal"]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(ee).toLocaleString("es-CL")]})]}),ea.filter(e=>e.total>0).map(e=>(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.accountCode," - ",e.name]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(e.total).toLocaleString("es-CL")]})]},e.code)),et<0&&e?.purchasesInvoicesPayableAccount&&(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.purchasesInvoicesPayableAccount," - Disminución Proveedores"]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-et).toLocaleString("es-CL")]})]})]}),(0,a.jsx)(h.TableFooter,{children:(0,a.jsxs)(h.TableRow,{className:"font-bold text-base",children:[(0,a.jsx)(h.TableCell,{children:"Total Debe"}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(K).toLocaleString("es-CL")]})]})})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"font-semibold text-lg",children:"HABER (Abonos)"}),(0,a.jsxs)(h.Table,{children:[(0,a.jsx)(h.TableHeader,{children:(0,a.jsxs)(h.TableRow,{children:[(0,a.jsx)(h.TableHead,{children:"Cuenta Contable"}),(0,a.jsx)(h.TableHead,{className:"text-right",children:"Monto"})]})}),(0,a.jsxs)(h.TableBody,{children:[U.filter(e=>e.totalNet<0).map(e=>(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.accountCode," - ",e.accountName]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-e.totalNet).toLocaleString("es-CL")]})]},e.accountCode)),ee<0&&e?.purchasesVatAccount&&(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.purchasesVatAccount," - Ajuste IVA Crédito"]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-ee).toLocaleString("es-CL")]})]}),ea.filter(e=>e.total<0).map(e=>(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.accountCode," - Ajuste ",e.name]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-e.total).toLocaleString("es-CL")]})]},e.code)),et>0&&e?.purchasesInvoicesPayableAccount&&(0,a.jsxs)(h.TableRow,{children:[(0,a.jsxs)(h.TableCell,{children:[e.purchasesInvoicesPayableAccount," - Proveedores"]}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(et).toLocaleString("es-CL")]})]})]}),(0,a.jsx)(h.TableFooter,{children:(0,a.jsxs)(h.TableRow,{className:"font-bold text-base",children:[(0,a.jsx)(h.TableCell,{children:"Total Haber"}),(0,a.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(Y).toLocaleString("es-CL")]})]})})]})]})]})]}),(0,a.jsxs)(s.CardFooter,{className:"flex flex-col items-end gap-4 pt-6",children:[(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsx)("p",{className:`font-bold ${X?"text-green-600":"text-destructive"}`,children:X?"El asiento está cuadrado.":"El asiento no está cuadrado."}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Diferencia: $",(Math.round(K)-Math.round(Y)).toLocaleString("es-CL")]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(r.Button,{variant:"outline",asChild:!0,children:(0,a.jsx)(f.default,{href:"/dashboard/purchases",children:"Cancelar"})}),(0,a.jsx)(r.Button,{onClick:er,disabled:!Q||q,children:q?"Procesando...":"Centralizar y Contabilizar"})]})]})]}),(0,a.jsx)(T.Dialog,{open:O,onOpenChange:B,children:(0,a.jsxs)(T.DialogContent,{children:[(0,a.jsxs)(T.DialogHeader,{children:[(0,a.jsx)(T.DialogTitle,{children:"Asignar Cuenta a Documentos Pendientes"}),(0,a.jsxs)(T.DialogDescription,{children:["Selecciona la cuenta de gasto que deseas asignar a los ",W," documentos sin clasificar."]})]}),(0,a.jsx)("div",{className:"py-4",children:(0,a.jsx)(A.AccountSearchInput,{label:"Cuenta de Gasto/Costo",value:z||"",onValueChange:V,accounts:F||[],loading:$})}),(0,a.jsxs)(T.DialogFooter,{children:[(0,a.jsx)(T.DialogClose,{asChild:!0,children:(0,a.jsx)(r.Button,{type:"button",variant:"secondary",children:"Cancelar"})}),(0,a.jsx)(r.Button,{type:"button",onClick:()=>{z&&(k(e=>e.map(e=>e.assignedAccount?e:{...e,assignedAccount:z})),P({title:"Cuentas Asignadas",description:`Se asign\xf3 la cuenta ${z} a todos los documentos sin cuenta.`}),B(!1),V(null))},disabled:!z,children:q?"Guardando...":"Guardar y Asignar"})]})]})})]}):(0,a.jsxs)(s.Card,{children:[(0,a.jsx)(s.CardHeader,{children:(0,a.jsx)(s.CardTitle,{children:"Sin Documentos Pendientes"})}),(0,a.jsx)(s.CardContent,{children:(0,a.jsxs)("p",{className:"text-muted-foreground",children:["No hay documentos de compra pendientes por centralizar. ",(0,a.jsx)(f.default,{href:"/dashboard/purchases",className:"text-primary underline",children:"Volver al libro de compras"}),"."]})})]})}e.s(["default",()=>w])}]);
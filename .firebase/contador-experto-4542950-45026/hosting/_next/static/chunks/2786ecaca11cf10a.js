(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,29592,e=>{"use strict";var r=e.i(43476),t=e.i(71645),a=e.i(25913),i=e.i(75157);let s=(0,a.cva)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),l=t.forwardRef(({className:e,variant:t,...a},l)=>(0,r.jsx)("div",{ref:l,role:"alert",className:(0,i.cn)(s({variant:t}),e),...a}));l.displayName="Alert";let d=t.forwardRef(({className:e,...t},a)=>(0,r.jsx)("h5",{ref:a,className:(0,i.cn)("mb-1 font-medium leading-none tracking-tight",e),...t}));d.displayName="AlertTitle";let o=t.forwardRef(({className:e,...t},a)=>(0,r.jsx)("div",{ref:a,className:(0,i.cn)("text-sm [&_p]:leading-relaxed",e),...t}));o.displayName="AlertDescription",e.s(["Alert",()=>l,"AlertDescription",()=>o,"AlertTitle",()=>d])},32060,e=>{"use strict";var r=e.i(43476),t=e.i(71645),a=e.i(15288),i=e.i(19455),s=e.i(70756),l=e.i(10980),d=e.i(39126);e.i(11981);var o=e.i(61480),n=e.i(80428);e.i(36180);var c=e.i(17875),u=e.i(8406),p=e.i(57094),x=e.i(50350),h=e.i(45919),m=e.i(35684);function f(e){let r=(0,m.toDate)(e),t=r.getFullYear();return r.setFullYear(t+1,0,0),r.setHours(23,59,59,999),r}var j=e.i(67027),v=e.i(86135),g=e.i(67489),C=e.i(10204),b=e.i(29592),y=e.i(18566);function A(){let{selectedCompany:e}=t.default.useContext(d.SelectedCompanyContext)||{},m=e?.id,A=(0,o.useFirestore)(),{toast:w}=(0,u.useToast)(),N=(0,y.useRouter)(),[S,D]=t.default.useState(!1),[T,$]=t.default.useState(new Date().getFullYear()),E=new Date().getFullYear(),{data:P,loading:F}=(0,n.useCollection)({path:m?`companies/${m}/accounts`:void 0}),R=t.default.useMemo(()=>A&&m?(0,c.query)((0,c.collection)(A,`companies/${m}/vouchers`),(0,c.where)("status","==","Contabilizado")):null,[A,m]),{data:k,loading:B}=(0,n.useCollection)({query:R}),G=F||B,M=t.default.useCallback(()=>{if(!P||!k)return new Map;let e=(0,j.startOfYear)(new Date(T,0,1)),r=f(new Date(T,11,31)),t=k.filter(t=>{let a=(0,v.parseISO)(t.date);return a>=e&&a<=r}),a=new Map;return P.forEach(e=>a.set(e.code,e.balance)),t.forEach(e=>{e.entries.forEach(e=>{let r=a.get(e.account)||0,t=P.find(r=>r.code===e.account)?.type;"Activo"===t||"Resultado"===t?a.set(e.account,r+e.debit-e.credit):a.set(e.account,r+e.credit-e.debit)})}),a},[P,k,T]),O=async()=>{if(!P||!e||!A)return;D(!0);let r=M(),t=P.filter(e=>"Resultado"===e.type),a=[],i=0;if(t.forEach(e=>{let t=r.get(e.code)||0;0!==t&&(e.code.startsWith("4")?(a.push({account:e.code,description:`Saldo Cierre ${e.name}`,debit:t,credit:0}),i-=t):(a.push({account:e.code,description:`Saldo Cierre ${e.name}`,debit:0,credit:t}),i+=t))}),0===a.length){w({title:"Sin movimiento",description:"No hay cuentas de resultado con saldo para cerrar."}),D(!1);return}let s=e.profitAccount||"30203";i>0?a.push({account:s,description:`P\xe9rdida del Ejercicio ${T}`,debit:i,credit:0}):a.push({account:s,description:`Utilidad del Ejercicio ${T}`,debit:0,credit:-i});let l=a.reduce((e,r)=>e+r.debit,0),d={date:(0,h.format)(f(new Date(T,11,31)),"yyyy-MM-dd"),type:"Traspaso",description:`Comprobante de Cierre Ejercicio ${T}`,status:"Contabilizado",total:l,entries:a,companyId:m};try{await (0,c.addDoc)((0,c.collection)(A,`companies/${m}/vouchers`),d),w({title:"Cierre Generado",description:`Se cre\xf3 el comprobante de cierre para el a\xf1o ${T}.`}),N.push("/dashboard/vouchers")}catch(e){p.errorEmitter.emit("permission-error",new x.FirestorePermissionError({path:`companies/${m}/vouchers`,operation:"create"}))}finally{D(!1)}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)(a.Card,{children:[(0,r.jsxs)(a.CardHeader,{children:[(0,r.jsx)(a.CardTitle,{children:"Cierre Anual"}),(0,r.jsx)(a.CardDescription,{children:"Genera los asientos de cierre de fin de año y prepara la apertura del siguiente período."})]}),(0,r.jsx)(a.CardContent,{children:(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center gap-6 rounded-xl border border-dashed p-8 text-center max-w-2xl mx-auto",children:[(0,r.jsx)(s.Lock,{className:"h-12 w-12 text-primary"}),(0,r.jsxs)("h3",{className:"text-lg font-semibold",children:["Proceso de Cierre y Apertura para ",(0,r.jsx)("span",{className:"text-primary",children:e?.name||"..."})]}),(0,r.jsxs)("div",{className:"space-y-2 w-full max-w-xs",children:[(0,r.jsx)(C.Label,{htmlFor:"year-select",children:"Selecciona el año a cerrar"}),(0,r.jsxs)(g.Select,{value:T.toString(),onValueChange:e=>$(parseInt(e)),children:[(0,r.jsx)(g.SelectTrigger,{id:"year-select",children:(0,r.jsx)(g.SelectValue,{})}),(0,r.jsx)(g.SelectContent,{children:Array.from({length:5},(e,r)=>E-r).map(e=>(0,r.jsx)(g.SelectItem,{value:e.toString(),children:e},e))})]})]}),(0,r.jsxs)(b.Alert,{children:[(0,r.jsx)(l.BookOpen,{className:"h-4 w-4"}),(0,r.jsx)(b.AlertTitle,{children:"Pasos del Proceso"}),(0,r.jsx)(b.AlertDescription,{className:"text-left",children:(0,r.jsxs)("ol",{className:"list-decimal list-inside space-y-1",children:[(0,r.jsxs)("li",{children:[(0,r.jsx)("b",{children:"1. Cierre Anual:"})," Saldará las cuentas de resultado y transferirá la utilidad o pérdida al patrimonio."]}),(0,r.jsxs)("li",{children:[(0,r.jsx)("b",{children:"2. Apertura Anual:"})," Creará el asiento inicial para el próximo año con los saldos de activo, pasivo y patrimonio. (Función Próximamente)."]})]})})]}),(0,r.jsx)(i.Button,{onClick:O,disabled:!m||G||S,className:"w-full",children:G?"Cargando...":S?"Procesando Cierre...":`Generar Asiento de Cierre ${T}`})]})})]}),(0,r.jsxs)(a.Card,{children:[(0,r.jsxs)(a.CardHeader,{children:[(0,r.jsx)(a.CardTitle,{children:"Asiento de Apertura"}),(0,r.jsx)(a.CardDescription,{children:"Genera el comprobante de apertura para el siguiente período fiscal."})]}),(0,r.jsx)(a.CardContent,{children:(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center gap-4 rounded-xl border border-dashed p-8 text-center",children:[(0,r.jsx)("p",{className:"text-muted-foreground",children:"Esta funcionalidad estará disponible próximamente."}),(0,r.jsxs)(i.Button,{disabled:!0,children:["Generar Asiento de Apertura ",T+1]})]})})]})]})}e.s(["default",()=>A],32060)}]);
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,15288,e=>{"use strict";var t=e.i(43476),a=e.i(71645),s=e.i(75157);let l=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("div",{ref:l,className:(0,s.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",e),...a}));l.displayName="Card";let r=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("div",{ref:l,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",e),...a}));r.displayName="CardHeader";let i=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("div",{ref:l,className:(0,s.cn)("text-2xl font-semibold leading-none tracking-tight",e),...a}));i.displayName="CardTitle";let o=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("div",{ref:l,className:(0,s.cn)("text-sm text-muted-foreground",e),...a}));o.displayName="CardDescription";let n=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("div",{ref:l,className:(0,s.cn)("p-6 pt-0",e),...a}));n.displayName="CardContent";let d=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("div",{ref:l,className:(0,s.cn)("flex items-center p-6 pt-0",e),...a}));d.displayName="CardFooter",e.s(["Card",()=>l,"CardContent",()=>n,"CardDescription",()=>o,"CardFooter",()=>d,"CardHeader",()=>r,"CardTitle",()=>i])},84774,e=>{"use strict";var t=e.i(43476),a=e.i(71645),s=e.i(75157);let l=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("div",{className:"relative w-full overflow-auto",children:(0,t.jsx)("table",{ref:l,className:(0,s.cn)("w-full caption-bottom text-sm",e),...a})}));l.displayName="Table";let r=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("thead",{ref:l,className:(0,s.cn)("[&_tr]:border-b",e),...a}));r.displayName="TableHeader";let i=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("tbody",{ref:l,className:(0,s.cn)("[&_tr:last-child]:border-0",e),...a}));i.displayName="TableBody";let o=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("tfoot",{ref:l,className:(0,s.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",e),...a}));o.displayName="TableFooter";let n=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("tr",{ref:l,className:(0,s.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",e),...a}));n.displayName="TableRow";let d=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("th",{ref:l,className:(0,s.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",e),...a}));d.displayName="TableHead";let c=a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("td",{ref:l,className:(0,s.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",e),...a}));c.displayName="TableCell",a.forwardRef(({className:e,...a},l)=>(0,t.jsx)("caption",{ref:l,className:(0,s.cn)("mt-4 text-sm text-muted-foreground",e),...a})).displayName="TableCaption",e.s(["Table",()=>l,"TableBody",()=>i,"TableCell",()=>c,"TableFooter",()=>o,"TableHead",()=>d,"TableHeader",()=>r,"TableRow",()=>n])},88515,e=>{"use strict";var t=e.i(35684);function a(e){let a=(0,t.toDate)(e),s=a.getMonth();return a.setFullYear(a.getFullYear(),s+1,0),a.setHours(0,0,0,0),a}e.s(["lastDayOfMonth",()=>a])},38815,e=>{"use strict";var t=e.i(35684);function a(e,a){return+(0,t.toDate)(e)<+(0,t.toDate)(a)}e.s(["isBefore",()=>a])},29592,e=>{"use strict";var t=e.i(43476),a=e.i(71645),s=e.i(25913),l=e.i(75157);let r=(0,s.cva)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),i=a.forwardRef(({className:e,variant:a,...s},i)=>(0,t.jsx)("div",{ref:i,role:"alert",className:(0,l.cn)(r({variant:a}),e),...s}));i.displayName="Alert";let o=a.forwardRef(({className:e,...a},s)=>(0,t.jsx)("h5",{ref:s,className:(0,l.cn)("mb-1 font-medium leading-none tracking-tight",e),...a}));o.displayName="AlertTitle";let n=a.forwardRef(({className:e,...a},s)=>(0,t.jsx)("div",{ref:s,className:(0,l.cn)("text-sm [&_p]:leading-relaxed",e),...a}));n.displayName="AlertDescription",e.s(["Alert",()=>i,"AlertDescription",()=>n,"AlertTitle",()=>o])},63209,e=>{"use strict";let t=(0,e.i(75254).default)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);e.s(["AlertCircle",()=>t],63209)},59500,e=>{"use strict";var t=e.i(35684);function a(e,a){return+(0,t.toDate)(e)==+(0,t.toDate)(a)}e.s(["isEqual",()=>a])},64188,e=>{"use strict";var t=e.i(43476),a=e.i(71645),s=e.i(15288),l=e.i(19455);e.i(11981);var r=e.i(80428),i=e.i(61480);e.i(36180);var o=e.i(17875),n=e.i(57094),d=e.i(50350),c=e.i(39126),u=e.i(8406),x=e.i(18566),h=e.i(84774),m=e.i(29592),b=e.i(63209),f=e.i(22016),p=e.i(45919),j=e.i(88515),C=e.i(86135),g=e.i(68264),T=e.i(59500),v=e.i(38815),N=e.i(43104);function y(){let{selectedCompany:e}=a.default.useContext(c.SelectedCompanyContext)||{},y=e?.id,A=(0,i.useFirestore)(),{toast:w}=(0,u.useToast)(),R=(0,x.useRouter)(),D=a.default.useMemo(()=>A&&y?(0,o.query)((0,o.collection)(A,`companies/${y}/sales`),(0,o.where)("status","==","Pendiente")):null,[A,y]),{data:M,loading:L}=(0,r.useCollection)({query:D}),[S,V]=a.default.useState(!1),{totalNet:F,totalIvaDebit:I,otherTaxesSummary:$,totalReceivable:E,totalDebit:H,totalCredit:B,closedPeriodDocs:z,salesToProcess:P,isValid:k,isBalanced:q,missingTaxAccounts:O}=a.default.useMemo(()=>{if(!M||!e)return{totalNet:0,totalIvaDebit:0,otherTaxesSummary:[],totalReceivable:0,totalDebit:0,totalCredit:0,closedPeriodDocs:[],salesToProcess:[],isValid:!1,isBalanced:!1,missingTaxAccounts:[]};let t=e.lastClosedDate?(0,C.parseISO)(e.lastClosedDate):null,a=M.filter(e=>{if(!t)return!0;let a=(0,C.parseISO)(e.date);return(0,g.isAfter)(a,t)}),s=M.filter(e=>{if(!t)return!1;let a=(0,C.parseISO)(e.date);return(0,v.isBefore)(a,t)||(0,T.isEqual)(a,t)}),l=new Map,r=0,i=0,o=0,n=0;a.forEach(e=>{let t=e.documentType.includes("61")?-1:1;r+=(e.netAmount||0)*t,i+=(e.exemptAmount||0)*t,o+=(e.taxAmount||0)*t,n+=e.total*t,e.otherTaxes?.forEach(e=>{let a=(e.amount||0)*t,s=l.get(e.code)||{name:e.name,total:0};s.total+=a,l.set(e.code,s)})});let d=new Map(e.salesOtherTaxesAccounts?.map(e=>[e.taxCode,e.accountCode])),c=Array.from(l.entries()).map(([e,t])=>({code:e,name:t.name,total:t.total,accountCode:d.get(e)})),u=c.filter(e=>0!==e.total&&!e.accountCode),x=r+i,h=c.reduce((e,t)=>e+t.total,0),m=n,b=x+o+h,f=Math.round(m)===Math.round(b),p=a.length>0&&!!e.salesInvoicesReceivableAccount&&!!e.salesVatAccount&&0===u.length&&f;return{totalNet:x,totalIvaDebit:o,otherTaxesSummary:c,totalReceivable:n,totalDebit:m,totalCredit:b,closedPeriodDocs:s,salesToProcess:a,isValid:p,isBalanced:f,missingTaxAccounts:u}},[M,e]),Y=async()=>{if(!A||!y||!e||!P||!k)return void w({variant:"destructive",title:"Error de validación",description:"No se puede centralizar. Revisa que las cuentas de venta estén configuradas, que todos los impuestos tengan su cuenta y que el asiento esté cuadrado."});V(!0);let t=e.periodStartDate?(0,C.parseISO)(e.periodStartDate):new Date,a=(0,j.lastDayOfMonth)(t),s=(0,p.format)(t,"MMMM",{locale:N.es}),l=[];0!==E&&l.push({account:e.salesInvoicesReceivableAccount,description:`Centralizaci\xf3n Ventas Clientes`,debit:E>0?E:0,credit:E<0?-E:0});let r=e.profitAccount||"4010110";0!==F&&l.push({account:r,description:`Ventas del per\xedodo`,debit:F<0?-F:0,credit:F>0?F:0}),0!==I&&e.salesVatAccount&&l.push({account:e.salesVatAccount,description:"IVA Débito Fiscal del período",debit:I<0?-I:0,credit:I>0?I:0}),$.forEach(e=>{0!==e.total&&e.accountCode&&l.push({account:e.accountCode,description:e.name,debit:e.total<0?-e.total:0,credit:e.total>0?e.total:0})});let i=l.filter(e=>0!==e.debit||0!==e.credit),c={date:(0,p.format)(a,"yyyy-MM-dd"),type:"Traspaso",description:`Centralizaci\xf3n Ventas ${s} ${t.getFullYear()}`,status:"Contabilizado",total:Math.abs(i.reduce((e,t)=>e+t.debit,0)),entries:i,companyId:y,createdAt:o.Timestamp.now()},u=(0,o.writeBatch)(A),x=(0,o.doc)((0,o.collection)(A,`companies/${y}/vouchers`));u.set(x,c),P.forEach(e=>{u.update((0,o.doc)(A,`companies/${y}/sales`,e.id),{status:"Contabilizado",voucherId:x.id})});try{await u.commit(),w({title:"Centralización Exitosa",description:"El comprobante de ventas ha sido generado y las ventas actualizadas."}),R.push("/dashboard/vouchers")}catch(e){n.errorEmitter.emit("permission-error",new d.FirestorePermissionError({path:`companies/${y}`,operation:"update"})),V(!1)}};return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold tracking-tight",children:"2. Vista Previa y Centralización de Ventas"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Verifica los totales y confirma la generación del asiento contable."})]}),L&&(0,t.jsx)("p",{children:"Cargando vista previa..."}),!L&&M&&0===M.length&&(0,t.jsxs)(s.Card,{children:[(0,t.jsx)(s.CardHeader,{children:(0,t.jsx)(s.CardTitle,{children:"Sin Documentos Pendientes"})}),(0,t.jsx)(s.CardContent,{children:(0,t.jsx)("p",{className:"text-muted-foreground",children:"No hay documentos de venta pendientes por centralizar."})})]}),!L&&M&&M.length>0&&(0,t.jsxs)(s.Card,{children:[(0,t.jsx)(s.CardHeader,{children:(0,t.jsx)(s.CardTitle,{children:"Resumen del Asiento a Generar"})}),(0,t.jsxs)(s.CardContent,{children:[O.length>0&&(0,t.jsxs)(m.Alert,{variant:"destructive",className:"mb-4",children:[(0,t.jsx)(b.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)(m.AlertTitle,{children:"Faltan Cuentas de Impuestos Adicionales"}),(0,t.jsxs)(m.AlertDescription,{children:[(0,t.jsxs)("p",{children:["Para poder centralizar, debes asignar una cuenta contable a los siguientes impuestos en la ",(0,t.jsx)(f.default,{href:"/dashboard/companies/settings",className:"font-bold underline",children:"configuración de la empresa"}),":"]}),(0,t.jsx)("ul",{className:"list-disc pl-5 mt-2 text-xs",children:O.map(e=>(0,t.jsx)("li",{children:e.name},e.code))})]})]}),z.length>0&&(0,t.jsxs)(m.Alert,{variant:"destructive",className:"mb-4",children:[(0,t.jsx)(b.AlertCircle,{className:"h-4 w-4"}),(0,t.jsxs)(m.AlertTitle,{children:["Atención Requerida: ",z.length," Documento(s) en Período Cerrado"]}),(0,t.jsxs)(m.AlertDescription,{children:[(0,t.jsx)("p",{children:"Estos documentos no serán incluidos en esta centralización y permanecerán pendientes:"}),(0,t.jsxs)("ul",{className:"list-disc pl-5 mt-2 text-xs",children:[z.slice(0,5).map(e=>(0,t.jsxs)("li",{children:["Folio ",e.documentNumber," de ",e.customer," (Fecha: ",new Date(e.date).toLocaleDateString("es-CL"),")"]},e.id)),z.length>5&&(0,t.jsxs)("li",{children:["... y ",z.length-5," más."]})]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("h3",{className:"font-semibold text-lg",children:"DEBE (Cargos)"}),(0,t.jsxs)(h.Table,{children:[(0,t.jsx)(h.TableHeader,{children:(0,t.jsxs)(h.TableRow,{children:[(0,t.jsx)(h.TableHead,{children:"Cuenta Contable"}),(0,t.jsx)(h.TableHead,{className:"text-right",children:"Monto"})]})}),(0,t.jsxs)(h.TableBody,{children:[E>0&&(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e?.salesInvoicesReceivableAccount," - Clientes"]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(E).toLocaleString("es-CL")]})]}),F<0&&(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e?.profitAccount||"4010110"," - Ajuste Ingreso por Ventas"]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-F).toLocaleString("es-CL")]})]}),I<0&&(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e?.salesVatAccount," - Ajuste IVA Débito Fiscal"]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-I).toLocaleString("es-CL")]})]}),$.filter(e=>e.total<0).map(e=>(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e.accountCode," - Ajuste ",e.name]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-e.total).toLocaleString("es-CL")]})]},e.code))]}),(0,t.jsx)(h.TableFooter,{children:(0,t.jsxs)(h.TableRow,{className:"font-bold text-base",children:[(0,t.jsx)(h.TableCell,{children:"Total Debe"}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(H).toLocaleString("es-CL")]})]})})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("h3",{className:"font-semibold text-lg",children:"HABER (Abonos)"}),(0,t.jsxs)(h.Table,{children:[(0,t.jsx)(h.TableHeader,{children:(0,t.jsxs)(h.TableRow,{children:[(0,t.jsx)(h.TableHead,{children:"Cuenta Contable"}),(0,t.jsx)(h.TableHead,{className:"text-right",children:"Monto"})]})}),(0,t.jsxs)(h.TableBody,{children:[F>0&&(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e?.profitAccount||"4010110"," - Ingreso por Ventas"]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(F).toLocaleString("es-CL")]})]}),I>0&&(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e?.salesVatAccount," - IVA Débito Fiscal"]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(I).toLocaleString("es-CL")]})]}),$.filter(e=>e.total>0).map(e=>(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e.accountCode," - ",e.name]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(e.total).toLocaleString("es-CL")]})]},e.code)),E<0&&(0,t.jsxs)(h.TableRow,{children:[(0,t.jsxs)(h.TableCell,{children:[e?.salesInvoicesReceivableAccount," - Disminución Clientes"]}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(-E).toLocaleString("es-CL")]})]})]}),(0,t.jsx)(h.TableFooter,{children:(0,t.jsxs)(h.TableRow,{className:"font-bold text-base",children:[(0,t.jsx)(h.TableCell,{children:"Total Haber"}),(0,t.jsxs)(h.TableCell,{className:"text-right",children:["$",Math.round(B).toLocaleString("es-CL")]})]})})]})]})]})]}),(0,t.jsxs)(s.CardFooter,{className:"flex flex-col items-end gap-4 pt-6",children:[(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsx)("p",{className:`font-bold ${q?"text-green-600":"text-destructive"}`,children:q?"El asiento está cuadrado.":"El asiento no está cuadrado."}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Diferencia: $",(Math.round(H)-Math.round(B)).toLocaleString("es-CL")]})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(l.Button,{variant:"outline",asChild:!0,children:(0,t.jsx)(f.default,{href:"/dashboard/sales",children:"Atrás"})}),(0,t.jsx)(l.Button,{onClick:Y,disabled:!k||S,children:S?"Procesando...":"Centralizar y Contabilizar"})]})]})]})]})}e.s(["default",()=>y])}]);